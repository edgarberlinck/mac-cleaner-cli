name: Update Homebrew Formula

on:
  release:
    types: [published]

jobs:
  homebrew:
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get release info
        id: release
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download release tarball and get SHA256
        id: sha
        run: |
          curl -L -o release.tar.gz "https://github.com/${{ github.repository }}/releases/download/v${{ steps.release.outputs.version }}/clean-my-mac-${{ steps.release.outputs.version }}.tar.gz"
          SHA256=$(shasum -a 256 release.tar.gz | cut -d ' ' -f 1)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT

      - name: Update Homebrew formula
        run: |
          cat > homebrew/clean-my-mac.rb << 'EOF'
          class CleanMyMac < Formula
            desc "Open source CLI tool to clean your Mac"
            homepage "https://github.com/${{ github.repository }}"
            url "https://github.com/${{ github.repository }}/releases/download/v${{ steps.release.outputs.version }}/clean-my-mac-${{ steps.release.outputs.version }}.tar.gz"
            sha256 "${{ steps.sha.outputs.sha256 }}"
            license "MIT"

            depends_on "node@20"

            def install
              libexec.install Dir["*"]
              bin.install_symlink libexec/"node_modules/.bin/clean-my-mac" => "clean-my-mac"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/clean-my-mac --version")
            end
          end
          EOF

      - name: Commit and push formula
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add homebrew/clean-my-mac.rb
          git commit -m "chore: update homebrew formula to v${{ steps.release.outputs.version }}" || exit 0
          git push
